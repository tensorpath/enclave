name: Release Enclave

on:
  push:
    tags:
      - 'enclave-v*'

permissions:
  contents: write
  id-token: write
  attestations: write
  packages: write

jobs:
  build-and-release:
    name: Build, Attest, Release
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install binutils

      - name: Build Release Artifacts
        run: |
          chmod +x build_release.sh
          ./build_release.sh

      - name: Prepare Artifacts
        run: |
          mkdir -p release_dist
          cp dist/enclave release_dist/enclave_linux_amd64

          {
            echo "tag=${GITHUB_REF_NAME}"
            echo "commit=${GITHUB_SHA}"
            echo "built_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner=${RUNNER_OS}/${RUNNER_ARCH}"
          } > release_dist/build_manifest.txt

      - name: Generate Checksums
        working-directory: ./release_dist
        run: |
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Setup Cosign
        uses: sigstore/cosign-installer@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push OCI Artifact Bundle to GHCR
        env:
          OCI_IMAGE: ghcr.io/${{ github.repository_owner }}/enclave
          OCI_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          push_output="$(oras push "${OCI_IMAGE}:${OCI_TAG}" \
            --artifact-type application/vnd.tensorpath.enclave.runtime.bundle.v1 \
            release_dist/enclave_linux_amd64:application/vnd.tensorpath.enclave.binary \
            release_dist/checksums.txt:text/plain \
            release_dist/build_manifest.txt:text/plain \
            --annotation "org.opencontainers.image.source=https://github.com/${GITHUB_REPOSITORY}" \
            --annotation "org.opencontainers.image.revision=${GITHUB_SHA}" \
            --annotation "org.opencontainers.image.version=${GITHUB_REF_NAME}")"
          echo "$push_output"
          digest="$(echo "$push_output" | awk '/Digest:/ {print $2}' | tail -n1)"
          if [ -z "$digest" ]; then
            echo "ERROR: failed to parse OCI digest from ORAS output" >&2
            exit 1
          fi
          echo "OCI_DIGEST=$digest" >> "$GITHUB_ENV"
          echo "OCI_IMAGE=$OCI_IMAGE" >> "$GITHUB_ENV"

      - name: Generate TensorPath Attestation Predicate
        run: |
          chmod +x generate_attestation.sh
          ./generate_attestation.sh \
            --release-dir=release_dist \
            --image-name="${OCI_IMAGE}" \
            --image-digest="${OCI_DIGEST}"
          ls -lah release_dist/attestation-*.json

      - name: Sign OCI Artifact (Keyless)
        env:
          COSIGN_YES: "true"
        run: |
          cosign sign "${OCI_IMAGE}@${OCI_DIGEST}"

      - name: Attach TensorPath Predicate Attestation (Keyless)
        env:
          COSIGN_YES: "true"
        run: |
          cosign attest \
            --type "https://tensorpath.dev/attestations/enclave-runtime/v1" \
            --predicate release_dist/attestation-predicate.json \
            "${OCI_IMAGE}@${OCI_DIGEST}"

      - name: Upload Build Provenance Attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            release_dist/enclave_linux_amd64
            release_dist/checksums.txt
            release_dist/build_manifest.txt
            release_dist/attestation-predicate.json
            release_dist/attestation-statement.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release_dist/enclave_linux_amd64
            release_dist/checksums.txt
            release_dist/build_manifest.txt
            release_dist/attestation-predicate.json
            release_dist/attestation-statement.json


